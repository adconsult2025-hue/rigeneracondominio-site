<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rigenera Condominio • Esito</title>
  <link rel="stylesheet" href="./assets/area.css" />
</head>
<body>
  <script src="./assets/vendor/auth0-spa-js.production.js"></script>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Rigenera Condominio</div>
          <div class="subtitle">Area Riservata • Condomini</div>
        </div>
      </div>
      <div class="actions">
        <span class="badge" title="Utente"><span class="dot"></span><span id="whoami" data-user-name>Ospite</span></span>
        <button class="btn" data-action="login">Accedi</button>
        <button class="btn danger" data-action="logout" style="display:none">Esci</button>
      </div>
    </div>
    <div class="dev-banner">MODALITÀ SVILUPPO – AREA TEMPORANEAMENTE APERTA (AUTH DISABILITATA)</div>
    
<div class="grid">
  <div class="card">
    <h1>Esito preliminare (Condominio)</h1>
    <p>Esito motivato. Per passare alla fase operativa, si attiva il progetto in piattaforma.</p>
    <div class="hr"></div>

    <div id="badge" class="badge warn"><span class="dot"></span><span id="badgeTxt">—</span></div>
    <div class="hr"></div>

    <h2>Riepilogo</h2>
    <pre class="mono" id="sum">—</pre>

    <div class="hr"></div>
    <h2>CTA</h2>
    <div id="cta" class="actions">—</div>

    <div class="footer-note">Nota: la valutazione è preliminare e non vincolante.</div>
  </div>

  <div class="card">
    <h2>Prossimi passi</h2>
    <div class="notice" id="nextSteps">—</div>
    <div class="hr"></div>
    <a class="btn secondary" href="./wizard.html">Rivedi risposte</a>
  </div>

  <div class="card">
    <h2>Contatti</h2>
    <p>Lascia i recapiti per ricevere supporto con il riepilogo della valutazione.</p>
    <div class="hr"></div>
    <label for="contactName">Nome e Cognome</label>
    <input id="contactName" type="text" name="name" placeholder="Es. Maria Rossi" required />

    <label for="contactEmail">Email</label>
    <input id="contactEmail" type="email" name="email" placeholder="nome@azienda.it" required />

    <label for="contactPhone">Telefono</label>
    <input id="contactPhone" type="tel" name="phone" placeholder="+39 ..." required />

    <label for="contactCondo">Condominio / Indirizzo (opzionale)</label>
    <input id="contactCondo" type="text" name="condo" placeholder="Via, città, interno" />

    <div class="hr"></div>
    <div class="actions">
      <button class="btn gold" id="sendLead">INVIA RICHIESTA</button>
    </div>
    <div id="leadNotice" class="notice" style="display:none"></div>
  </div>
</div>

  </div>

  <script type="module">
    import { isAuthed, login } from "./assets/auth0-client.js";
    // DEV: autenticazione forzata, nessun redirect verso login.
    await isAuthed();
  </script>
  <script type="module">
    import { login, logout, isAuthed, getUser as getAuthUser } from "./assets/auth0-client.js";
    import { mountTopbar, setUser, clearUser, getActiveRun, computeBadge } from "./assets/area.js";

    try { mountTopbar(); } catch(e) {}

    async function refreshUI(){
      const ok = await isAuthed();
      const user = ok ? await getAuthUser() : null;

      if (ok) {
        setUser({ id: user?.sub || user?.email, email: user?.email, name: user?.name || user?.email });
      } else {
        clearUser();
      }

      const loginBtn = document.querySelector("[data-action='login']");
      const logoutBtn = document.querySelector("[data-action='logout']");

      if (loginBtn) loginBtn.style.display = ok ? "none" : "";
      if (logoutBtn) logoutBtn.style.display = ok ? "" : "none";

      const elEmail = document.querySelector("[data-user-email]");
      const elName  = document.querySelector("[data-user-name]");
      if (elEmail) elEmail.textContent = user?.email || "Ospite";
      if (elName)  elName.textContent  = user?.name  || user?.email || "Ospite";
    }

    document.addEventListener("click", async (ev) => {
      const t = ev.target.closest("[data-action]");
      if (!t) return;
      const act = t.getAttribute("data-action");
      if (act === "login") {
        ev.preventDefault();
        await login("/area-riservata/esito.html");
      }
      if (act === "logout") {
        ev.preventDefault();
        await logout("https://www.rigeneracondominio.it/area-riservata/");
      }
    });

    refreshUI();

    const run = getActiveRun();
    if(!run) location.href="./dashboard.html";

    const b = computeBadge(run);
    const badge = document.querySelector("#badge");
    badge.classList.remove("ok","warn","bad");
    badge.classList.add(b.cls);
    document.querySelector("#badgeTxt").textContent = b.label;

    document.querySelector("#sum").textContent = JSON.stringify(run, null, 2);

    const cta = document.querySelector("#cta");
    const next = document.querySelector("#nextSteps");

    function li(items){ return "<ol>" + items.map(x=>`<li>${x}</li>`).join("") + "</ol>"; }

    if(run.status !== "completed"){
      cta.innerHTML = `<a class="btn gold" href="./wizard.html">Completa valutazione</a>`;
      next.innerHTML = "Completa il wizard per ottenere l’esito.";
    }else if(run.result === "stop_title"){
      cta.innerHTML = `<a class="btn" href="/contatti">Richiedi un confronto</a>`;
      next.innerHTML = li([
        "Integrare titolo/poteri (visure, procura, mandato, ecc.)",
        "Valutare alternative praticabili e perimetro d’intervento"
      ]);
    }else if(run.result === "stop_delibera"){
      cta.innerHTML = `<a class="btn" href="/contatti">Supporto per istruttoria assembleare</a>`;
      next.innerHTML = li([
        "Preparare percorso informativo e materiali assembleari",
        "Ripetere valutazione dopo consenso"
      ]);
    }else if(run.result === "efficiency"){
      cta.innerHTML = `<a class="btn gold" href="./attiva.html">Attiva analisi assistita</a>`;
      next.innerHTML = li([
        "Sopralluogo tecnico minimo",
        "Percorso alternativo (light/detrazioni) o sola CER se compatibile"
      ]);
    }else if(run.result === "limited"){
      cta.innerHTML = `<a class="btn gold" href="./attiva.html">Attiva (a pagamento)</a> <a class="btn secondary" href="/contatti">Analisi assistita</a>`;
      next.innerHTML = li([
        "Validazione requisiti e documenti",
        "Scelta governance completa per fase operativa"
      ]);
    }else if(run.result === "green"){
      cta.innerHTML = `<a class="btn gold" href="./attiva.html">Attiva progetto</a>`;
      next.innerHTML = li([
        "Attivazione in piattaforma (contratti + governance)",
        "Checklist documentale e piano CT/CER/Finanza"
      ]);
    }else{
      cta.innerHTML = `<a class="btn gold" href="./attiva.html">Attiva</a>`;
      next.innerHTML = "—";
    }

    const STORAGE_KEY = "rigeneraCondominio:area:v1";
    const btnLead = document.querySelector("#sendLead");
    const leadNotice = document.querySelector("#leadNotice");

    function getState(){
      try{
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
      }catch(e){
        return {};
      }
    }

    function pickRun(){
      const state = getState();
      const runs = Array.isArray(state.runs) ? state.runs : [];
      if(runs.length === 0) return null;
      const activeId = state.activeRunId;
      return runs.find(r => r.id === activeId) || runs[0];
    }

    function showLeadNotice(msg, ok){
      if(!leadNotice) return;
      leadNotice.textContent = msg;
      leadNotice.style.display = "block";
      if(ok){
        leadNotice.style.borderColor = "rgba(107,217,139,.45)";
        leadNotice.style.background = "rgba(107,217,139,.12)";
        leadNotice.style.color = "#d7e2de";
      }else{
        leadNotice.style.borderColor = "rgba(224,99,99,.45)";
        leadNotice.style.background = "rgba(224,99,99,.10)";
        leadNotice.style.color = "#f1d0d0";
      }
    }

    async function sendLead(){
      if(btnLead) btnLead.disabled = true;
      showLeadNotice("Invio in corso…", true);

      const contact = {
        name: document.querySelector("#contactName")?.value?.trim() || "",
        email: document.querySelector("#contactEmail")?.value?.trim() || "",
        phone: document.querySelector("#contactPhone")?.value?.trim() || "",
        condo: document.querySelector("#contactCondo")?.value?.trim() || ""
      };

      if(!contact.name || !contact.email || !contact.phone){
        showLeadNotice("Compila Nome e Cognome, Email e Telefono.", false);
        if(btnLead) btnLead.disabled = false;
        return;
      }

      const pickedRun = pickRun();
      if(!pickedRun || !pickedRun.answers || Object.keys(pickedRun.answers).length === 0){
        showLeadNotice("Nessuna valutazione trovata. Completa o riprendi il wizard.", false);
        if(btnLead) btnLead.disabled = false;
        return;
      }

      const payload = {
        contact,
        run: {
          id: pickedRun.id,
          created_at: pickedRun.created_at,
          updated_at: pickedRun.updated_at,
          current_step: pickedRun.current_step,
          status: pickedRun.status,
          result: pickedRun.result,
          notes: pickedRun.notes,
          answers: pickedRun.answers,
          user_id: pickedRun.user_id
        },
        userAgent: navigator.userAgent,
        pageUrl: location.href,
        ts: new Date().toISOString()
      };

      try{
        const res = await fetch("/.netlify/functions/lead-submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=> ({}));
        if(!res.ok || !data.ok){
          showLeadNotice("Errore nell’invio. Riprova tra poco.", false);
        }else{
          showLeadNotice("Richiesta inviata con successo! Ti ricontatteremo presto.", true);
        }
      }catch(e){
        showLeadNotice("Errore di rete: controlla la connessione e riprova.", false);
      }finally{
        if(btnLead) btnLead.disabled = false;
      }
    }

    if(btnLead){
      btnLead.addEventListener("click", (ev)=>{
        ev.preventDefault();
        sendLead();
      });
    }

  </script>
</body>
</html>
