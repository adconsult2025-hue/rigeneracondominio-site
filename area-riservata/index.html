<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rigenera Condominio • Area Riservata</title>
  <link rel="stylesheet" href="./assets/area.css" />
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Rigenera Condominio</div>
          <div class="subtitle">Area Riservata • Condomini</div>
        </div>
      </div>
      <div class="actions">
        <span class="badge" title="Utente"><span class="dot"></span><span id="whoami">Ospite</span></span>
        <button class="btn" data-action="login">Accedi</button>
        <button class="btn danger" data-action="logout" style="display:none">Esci</button>
      </div>
    </div>
    
<div class="grid">
  <div class="card">
    <h1>Accesso riservato</h1>
    <p>
      Quest’area è riservata ai condomìni autorizzati e consente una <b>valutazione preliminare guidata</b>
      (CT 3.0, CER/CEC, finanziamento) tramite un percorso <b>SI/NO</b>.
    </p>
    <div class="notice">
      L’accesso è <b>solo su invito</b>. Se hai ricevuto l’abilitazione, clicca “Accedi”.
      Se vuoi richiedere accesso, invia la richiesta tramite il modulo qui sotto.
    </div>
    <div class="hr"></div>

    <form name="richiesta-accesso-condominio" method="POST" data-netlify="true">
      <input type="hidden" name="form-name" value="richiesta-accesso-condominio" />
      <div class="form-row">
        <div>
          <label>Nome e Cognome</label>
          <input name="nome" required placeholder="Nome Cognome" />
        </div>
        <div>
          <label>Email</label>
          <input name="email" type="email" required placeholder="nome@email.it" />
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>Condominio (denominazione)</label>
          <input name="condominio" required placeholder="Condominio …" />
        </div>
        <div>
          <label>Città</label>
          <input name="citta" required placeholder="…" />
        </div>
      </div>
      <label>Messaggio</label>
      <textarea name="messaggio" placeholder="Breve descrizione esigenze, interventi, tempistiche…"></textarea>
      <div class="hr"></div>
      <button class="btn secondary" type="submit">Invia richiesta</button>
      <small class="help">Riceverai risposta con eventuale invito/abilitazione.</small>
    </form>
  </div>

  <div class="card">
    <h2>Come funziona</h2>
    <div class="kpis">
      <div class="kpi"><div class="k">1) Accesso su invito</div><div class="v">Netlify Identity</div></div>
      <div class="kpi"><div class="k">2) Wizard decisionale</div><div class="v">Domande SI/NO</div></div>
      <div class="kpi"><div class="k">3) Esito preliminare</div><div class="v">Percorso consigliato</div></div>
    </div>
    <div class="hr"></div>
    <a class="btn gold" href="./dashboard.html">Vai alla dashboard</a>
  </div>
</div>

  </div>

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
  (function () {
    var invite = sessionStorage.getItem("netlify_invite_token");
    var recovery = sessionStorage.getItem("netlify_recovery_token");

    // Costruiamo una URL "pulita" senza hash e usiamo querystring per preservare i token.
    var url = new URL(window.location.href);
    url.hash = "";

    if (invite) {
      sessionStorage.removeItem("netlify_invite_token");
      window.__netlifyOpenMode = "signup";
      url.searchParams.set("invite_token", invite);
      url.searchParams.delete("recovery_token");
      history.replaceState(null, "", url.toString());
    } else if (recovery) {
      sessionStorage.removeItem("netlify_recovery_token");
      window.__netlifyOpenMode = "recovery";
      url.searchParams.set("recovery_token", recovery);
      url.searchParams.delete("invite_token");
      history.replaceState(null, "", url.toString());
    } else {
      // Se il token è già presente nell'URL, deduci la modalità da querystring (preferita) o hash (fallback).
      var qi = url.searchParams.get("invite_token");
      var qr = url.searchParams.get("recovery_token");
      if (qi) window.__netlifyOpenMode = "signup";
      else if (qr) window.__netlifyOpenMode = "recovery";
      else {
        var h = window.location.hash || "";
        if (h.indexOf("invite_token=") !== -1) window.__netlifyOpenMode = "signup";
        else if (h.indexOf("recovery_token=") !== -1) window.__netlifyOpenMode = "recovery";
      }
    }
  })();
  </script>
  <script type="module">
    import { mountTopbar, wireIdentity, getUser } from './assets/area.js';
    wireIdentity();
    mountTopbar();

    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", function () {
        if (window.__netlifyOpenMode && !window.__handledNetlifyIdentityToken) {
          window.__handledNetlifyIdentityToken = true;
          window.netlifyIdentity.open(window.__netlifyOpenMode);
        }
      });

      // forza init se non ancora inizializzato
      try { window.netlifyIdentity.init(); } catch (e) {}

      // fallback: se init è già passato, prova ad aprire dopo un tick
      setTimeout(function () {
        if (window.__netlifyOpenMode && !window.__handledNetlifyIdentityToken) {
          window.__handledNetlifyIdentityToken = true;
          window.netlifyIdentity.open(window.__netlifyOpenMode);
        }
      }, 0);
    }

    // Se la pagina viene aperta da un invito Netlify Identity (invite_token nell'hash),
    // apri automaticamente il flusso di accettazione invito / impostazione password.
    // Gestiamo anche il reset password (recovery_token) per completezza.
    if (window.netlifyIdentity && !window.__handledNetlifyIdentityToken) {
      const h = window.location.hash || "";
      if (h.includes("invite_token")) {
        window.netlifyIdentity.open("signup");
      } else if (h.includes("recovery_token")) {
        window.netlifyIdentity.open("recovery");
      }
    }

    const user = getUser();
    const logoutBtn = document.querySelector("[data-action='logout']");
    const loginBtn = document.querySelector("[data-action='login']");
    if(user){
      logoutBtn.style.display = '';
      loginBtn.style.display = 'none';
    }
    
  </script>
</body>
</html>
