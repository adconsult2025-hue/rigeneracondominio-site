<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rigenera Condominio • Esito</title>
  <link rel="stylesheet" href="./assets/area.css" />
  <style>
    .file-list{list-style:none; margin:10px 0 0; padding:0; display:flex; flex-direction:column; gap:8px}
    .file-list li{display:flex; align-items:center; justify-content:space-between; gap:12px; font-size:12px; color: var(--text)}
    .file-list small{color: var(--muted)}
    .hidden-field{display:none !important}
    .confirm-box{border:1px solid rgba(107,217,139,.45); background:rgba(107,217,139,.12); padding:16px; border-radius:12px; color:#d7e2de; display:none}
    .confirm-box h3{margin-top:0}
    .confirm-meta{display:flex; flex-direction:column; gap:6px; font-size:14px}
    .confirm-code{font-size:20px; font-weight:700; letter-spacing:1px}
    .print-area{display:none}
    @media print{
      body *{visibility:hidden !important}
      .print-area, .print-area *{visibility:visible !important}
      .print-area{display:block; position:absolute; left:0; top:0; width:100%; padding:24px}
    }
  </style>
</head>
<body>
  <script src="./assets/vendor/auth0-spa-js.production.js"></script>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Rigenera Condominio</div>
          <div class="subtitle">Area Riservata • Condomini</div>
        </div>
      </div>
      <div class="actions">
        <span class="badge" title="Utente"><span class="dot"></span><span id="whoami" data-user-name>Ospite</span></span>
        <button class="btn" data-action="login">Accedi</button>
        <button class="btn danger" data-action="logout" style="display:none">Esci</button>
      </div>
    </div>
    <div class="dev-banner">MODALITÀ SVILUPPO – AREA TEMPORANEAMENTE APERTA (AUTH DISABILITATA)</div>
    
<div class="grid">
  <div class="card">
    <h1>Esito preliminare (Condominio)</h1>
    <p>Esito motivato. Per passare alla fase operativa, si attiva il progetto in piattaforma.</p>
    <div class="hr"></div>

    <div id="badge" class="badge warn"><span class="dot"></span><span id="badgeTxt">—</span></div>
    <div class="hr"></div>

    <h2>Riepilogo</h2>
    <pre class="mono" id="sum">—</pre>

    <div class="hr"></div>
    <h2>CTA</h2>
    <div id="cta" class="actions">—</div>

    <div class="footer-note">Nota: la valutazione è preliminare e non vincolante.</div>
  </div>

  <div class="card">
    <h2>Prossimi passi</h2>
    <div class="notice" id="nextSteps">—</div>
    <div class="hr"></div>
    <a class="btn secondary" href="./wizard.html">Rivedi risposte</a>
  </div>

  <div class="card">
    <h2>Contatti</h2>
    <p>Lascia i recapiti per ricevere supporto con il riepilogo della valutazione.</p>
    <div class="hr"></div>
    <label for="contactName">Nome e Cognome</label>
    <input id="contactName" type="text" name="name" placeholder="Es. Maria Rossi" required />

    <label for="contactEmail">Email</label>
    <input id="contactEmail" type="email" name="email" placeholder="nome@azienda.it" required />

    <label for="contactPhone">Telefono</label>
    <input id="contactPhone" type="tel" name="phone" placeholder="+39 ..." required />

    <label for="contactCondo">Condominio / Indirizzo (opzionale)</label>
    <input id="contactCondo" type="text" name="condo" placeholder="Via, città, interno" />

    <label for="contactCity">Città (opzionale)</label>
    <input id="contactCity" type="text" name="city" placeholder="Es. Milano" />

    <div class="hidden-field" aria-hidden="true">
      <label for="companyWebsite">Company Website</label>
      <input id="companyWebsite" type="text" name="company_website" autocomplete="off" tabindex="-1" />
    </div>

    <label for="leadAttachments">Allegati (PDF, JPG, PNG)</label>
    <input id="leadAttachments" type="file" name="attachments" multiple accept=".pdf,.png,.jpg,.jpeg,application/pdf,image/png,image/jpeg" />
    <small class="help">Puoi caricare più file (max 5, 15 MB cad.). Ogni allegato verrà caricato e inviato con un link dedicato.</small>
    <small class="help">I link agli allegati scadono dopo 7 giorni.</small>
    <ul id="leadFiles" class="file-list"></ul>
    <small id="uploadStatus" class="help"></small>

    <div class="hr"></div>
    <div class="actions">
      <button class="btn gold" id="sendLead">INVIA RICHIESTA</button>
    </div>
    <div id="leadNotice" class="notice" style="display:none"></div>
    <div id="leadConfirmation" class="confirm-box">
      <h3>Richiesta inviata correttamente. Ti contatteremo a breve.</h3>
      <div class="confirm-meta">
        <div>Codice pratica</div>
        <div id="leadCodeDisplay" class="confirm-code">—</div>
        <div>Data/ora invio: <span id="leadSubmittedAt">—</span></div>
      </div>
      <div class="actions" style="margin-top:12px">
        <button class="btn secondary" id="printLead">Scarica riepilogo</button>
      </div>
    </div>
  </div>
</div>

  </div>

  <script type="module">
    import { isAuthed, login } from "./assets/auth0-client.js";
    // DEV: autenticazione forzata, nessun redirect verso login.
    await isAuthed();
  </script>
  <script type="module">
    import { login, logout, isAuthed, getUser as getAuthUser } from "./assets/auth0-client.js";
    import { mountTopbar, setUser, clearUser, getActiveRun, computeBadge } from "./assets/area.js";

    try { mountTopbar(); } catch(e) {}

    async function refreshUI(){
      const ok = await isAuthed();
      const user = ok ? await getAuthUser() : null;

      if (ok) {
        setUser({ id: user?.sub || user?.email, email: user?.email, name: user?.name || user?.email });
      } else {
        clearUser();
      }

      const loginBtn = document.querySelector("[data-action='login']");
      const logoutBtn = document.querySelector("[data-action='logout']");

      if (loginBtn) loginBtn.style.display = ok ? "none" : "";
      if (logoutBtn) logoutBtn.style.display = ok ? "" : "none";

      const elEmail = document.querySelector("[data-user-email]");
      const elName  = document.querySelector("[data-user-name]");
      if (elEmail) elEmail.textContent = user?.email || "Ospite";
      if (elName)  elName.textContent  = user?.name  || user?.email || "Ospite";
    }

    document.addEventListener("click", async (ev) => {
      const t = ev.target.closest("[data-action]");
      if (!t) return;
      const act = t.getAttribute("data-action");
      if (act === "login") {
        ev.preventDefault();
        await login("/area-riservata/esito.html");
      }
      if (act === "logout") {
        ev.preventDefault();
        await logout("https://www.rigeneracondominio.it/area-riservata/");
      }
    });

    refreshUI();

    const run = getActiveRun();
    if(!run) location.href="./dashboard.html";

    const b = computeBadge(run);
    const badge = document.querySelector("#badge");
    badge.classList.remove("ok","warn","bad");
    badge.classList.add(b.cls);
    document.querySelector("#badgeTxt").textContent = b.label;

    document.querySelector("#sum").textContent = JSON.stringify(run, null, 2);

    const cta = document.querySelector("#cta");
    const next = document.querySelector("#nextSteps");

    function li(items){ return "<ol>" + items.map(x=>`<li>${x}</li>`).join("") + "</ol>"; }

    if(run.status !== "completed"){
      cta.innerHTML = `<a class="btn gold" href="./wizard.html">Completa valutazione</a>`;
      next.innerHTML = "Completa il wizard per ottenere l’esito.";
    }else if(run.result === "stop_title"){
      cta.innerHTML = "Richiedi contatto per presa in carico del caso. Nessun impegno. Verifica preliminare e indicazioni operative.";
      next.innerHTML = li([
        "Integrare titolo/poteri (visure, procura, mandato, ecc.)",
        "Valutare alternative praticabili e perimetro d’intervento"
      ]);
    }else if(run.result === "stop_delibera"){
      cta.innerHTML = "Richiedi contatto per presa in carico del caso. Nessun impegno. Verifica preliminare e indicazioni operative.";
      next.innerHTML = li([
        "Preparare percorso informativo e materiali assembleari",
        "Ripetere valutazione dopo consenso"
      ]);
    }else if(run.result === "efficiency"){
      cta.innerHTML = "Richiedi contatto per presa in carico del caso. Nessun impegno. Verifica preliminare e indicazioni operative.";
      next.innerHTML = li([
        "Sopralluogo tecnico minimo",
        "Percorso alternativo (light/detrazioni) o sola CER se compatibile"
      ]);
    }else if(run.result === "limited"){
      cta.innerHTML = "Richiedi contatto per presa in carico del caso. Nessun impegno. Verifica preliminare e indicazioni operative.";
      next.innerHTML = li([
        "Validazione requisiti e documenti",
        "Scelta governance completa per fase operativa"
      ]);
    }else if(run.result === "green"){
      cta.innerHTML = "Richiedi contatto per presa in carico del caso. Nessun impegno. Verifica preliminare e indicazioni operative.";
      next.innerHTML = li([
        "Attivazione in piattaforma (contratti + governance)",
        "Checklist documentale e piano CT/CER/Finanza"
      ]);
    }else{
      cta.innerHTML = "Richiedi contatto per presa in carico del caso. Nessun impegno. Verifica preliminare e indicazioni operative.";
      next.innerHTML = "—";
    }

    const STORAGE_KEY = "rigeneraCondominio:area:v1";
    const DRAFT_KEY = "rigeneraCondominio:leadDraft";
    const LAST_SUBMIT_KEY = "rigeneraCondominio:lastSubmit";
    const btnLead = document.querySelector("#sendLead");
    const leadNotice = document.querySelector("#leadNotice");
    const leadConfirmation = document.querySelector("#leadConfirmation");
    const leadCodeDisplay = document.querySelector("#leadCodeDisplay");
    const leadSubmittedAt = document.querySelector("#leadSubmittedAt");
    const printLead = document.querySelector("#printLead");
    const attachmentsInput = document.querySelector("#leadAttachments");
    const attachmentsList = document.querySelector("#leadFiles");
    const uploadStatus = document.querySelector("#uploadStatus");
    const honeypotInput = document.querySelector("#companyWebsite");
    let selectedFiles = [];
    let isSubmitting = false;
    let leadCodeValue = "";

    function getState(){
      try{
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
      }catch(e){
        return {};
      }
    }

    function pickRun(){
      const state = getState();
      const runs = Array.isArray(state.runs) ? state.runs : [];
      if(runs.length === 0) return null;
      const activeId = state.activeRunId;
      return runs.find(r => r.id === activeId) || runs[runs.length - 1];
    }

    function showLeadNotice(msg, ok, keepConfirmation = false){
      if(!leadNotice) return;
      if(leadConfirmation && !keepConfirmation) leadConfirmation.style.display = "none";
      leadNotice.textContent = msg;
      leadNotice.style.display = "block";
      if(ok){
        leadNotice.style.borderColor = "rgba(107,217,139,.45)";
        leadNotice.style.background = "rgba(107,217,139,.12)";
        leadNotice.style.color = "#d7e2de";
      }else{
        leadNotice.style.borderColor = "rgba(224,99,99,.45)";
        leadNotice.style.background = "rgba(224,99,99,.10)";
        leadNotice.style.color = "#f1d0d0";
      }
    }

    function showLeadConfirmation({ leadCode, submittedAt, failedAttachments = [] }){
      if(leadNotice) leadNotice.style.display = "none";
      if(leadCodeDisplay) leadCodeDisplay.textContent = leadCode || "—";
      if(leadSubmittedAt) leadSubmittedAt.textContent = submittedAt || "—";
      if(leadConfirmation) leadConfirmation.style.display = "block";
      window.leadCodeValue = leadCode || "";
      window.lastSubmittedAt = submittedAt || "";
      if(failedAttachments.length){
        const message = `${failedAttachments.length} allegato${failedAttachments.length === 1 ? "" : "i"} non caricato: ${failedAttachments.join(", ")}. Richiesta inviata comunque.`;
        showLeadNotice(message, true, true);
      }
    }

    function formatBytes(bytes){
      if(!Number.isFinite(bytes)) return "";
      const units = ["B", "KB", "MB", "GB"];
      let size = bytes;
      let idx = 0;
      while(size >= 1024 && idx < units.length - 1){
        size /= 1024;
        idx += 1;
      }
      return `${size.toFixed(size >= 10 || idx === 0 ? 0 : 1)} ${units[idx]}`;
    }

    function renderFileList(statuses = []){
      if(!attachmentsList) return;
      attachmentsList.innerHTML = "";
      selectedFiles.forEach((file, index) => {
        const li = document.createElement("li");
        const left = document.createElement("span");
        left.textContent = `${file.name} (${formatBytes(file.size)})`;
        const status = document.createElement("small");
        status.textContent = statuses[index] || "In attesa";
        li.appendChild(left);
        li.appendChild(status);
        attachmentsList.appendChild(li);
      });
    }

    function setUploadStatus(text){
      if(uploadStatus) uploadStatus.textContent = text || "";
    }

    function formatLeadCode(leadId){
      const date = new Date();
      const yyyymmdd = date.toISOString().slice(0, 10).replace(/-/g, "");
      const suffix = String(leadId || "").slice(-6).toUpperCase();
      return `RC-${yyyymmdd}-${suffix}`;
    }

    function generateLeadId(){
      if(window.crypto?.randomUUID) return window.crypto.randomUUID();
      const rand = () => Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
      return `${rand()}${rand()}-${rand()}-${rand()}-${rand()}-${rand()}${rand()}${rand()}`;
    }

    function readDraft(){
      try{
        return JSON.parse(localStorage.getItem(DRAFT_KEY) || "{}");
      }catch(e){
        return {};
      }
    }

    function saveDraft(values){
      localStorage.setItem(DRAFT_KEY, JSON.stringify(values));
    }

    function restoreDraft(){
      const draft = readDraft();
      const mapping = {
        "#contactName": draft.name,
        "#contactEmail": draft.email,
        "#contactPhone": draft.phone,
        "#contactCondo": draft.condo,
        "#contactCity": draft.city
      };
      Object.entries(mapping).forEach(([selector, value]) => {
        const el = document.querySelector(selector);
        if(el && value && !el.value) el.value = value;
      });
    }

    function wireDraftInputs(){
      const fields = [
        { id: "#contactName", key: "name" },
        { id: "#contactEmail", key: "email" },
        { id: "#contactPhone", key: "phone" },
        { id: "#contactCondo", key: "condo" },
        { id: "#contactCity", key: "city" }
      ];
      fields.forEach(({ id, key }) => {
        const el = document.querySelector(id);
        if(!el) return;
        el.addEventListener("input", () => {
          const current = readDraft();
          current[key] = el.value;
          saveDraft(current);
        });
      });
    }

    function getRecentSubmit(){
      try{
        return JSON.parse(localStorage.getItem(LAST_SUBMIT_KEY) || "{}");
      }catch(e){
        return {};
      }
    }

    function setRecentSubmit(data){
      localStorage.setItem(LAST_SUBMIT_KEY, JSON.stringify(data));
    }

    function validateFiles(files){
      const allowedTypes = new Set(["application/pdf", "image/jpeg", "image/png"]);
      const errors = [];
      if(files.length > 5){
        errors.push("Puoi caricare al massimo 5 allegati.");
      }
      files.forEach((file) => {
        if(!allowedTypes.has(file.type)){
          errors.push(`Formato non supportato per ${file.name}.`);
        }
        if(file.size > 15 * 1024 * 1024){
          errors.push(`${file.name} supera 15 MB.`);
        }
      });
      return errors;
    }

    if(attachmentsInput){
      attachmentsInput.addEventListener("change", (ev) => {
        selectedFiles = Array.from(ev.target.files || []);
        const errors = validateFiles(selectedFiles);
        const statuses = selectedFiles.map((file) => {
          if(file.size > 15 * 1024 * 1024) return "Errore: supera 15 MB";
          if(!["application/pdf", "image/jpeg", "image/png"].includes(file.type)) return "Errore: formato non valido";
          return "In attesa";
        });
        renderFileList(statuses);
        if(errors.length){
          setUploadStatus(errors.join(" "));
        }else{
          setUploadStatus(selectedFiles.length ? `Allegati selezionati: ${selectedFiles.length}` : "");
        }
      });
    }

    async function sendLead(){
      if(isSubmitting) return;
      isSubmitting = true;
      if(btnLead){
        btnLead.disabled = true;
        btnLead.textContent = "Invio in corso...";
      }
      showLeadNotice("Invio in corso…", true);
      setUploadStatus("");

      if(honeypotInput && honeypotInput.value.trim()){
        showLeadNotice("Errore nell’invio. Riprova tra poco.", false);
        if(btnLead){
          btnLead.disabled = false;
          btnLead.textContent = "INVIA RICHIESTA";
        }
        isSubmitting = false;
        return;
      }

      const contact = {
        name: document.querySelector("#contactName")?.value?.trim() || "",
        email: document.querySelector("#contactEmail")?.value?.trim() || "",
        phone: document.querySelector("#contactPhone")?.value?.trim() || "",
        condo: document.querySelector("#contactCondo")?.value?.trim() || "",
        city: document.querySelector("#contactCity")?.value?.trim() || ""
      };

      if(!contact.name || !contact.email || !contact.phone){
        showLeadNotice("Compila Nome e Cognome, Email e Telefono.", false);
        if(btnLead){
          btnLead.disabled = false;
          btnLead.textContent = "INVIA RICHIESTA";
        }
        isSubmitting = false;
        return;
      }

      const pickedRun = pickRun();
      if(!pickedRun || !pickedRun.answers || Object.keys(pickedRun.answers).length === 0){
        showLeadNotice("Nessuna valutazione trovata. Completa o riprendi il wizard.", false);
        if(btnLead){
          btnLead.disabled = false;
          btnLead.textContent = "INVIA RICHIESTA";
        }
        isSubmitting = false;
        return;
      }

      const leadId = generateLeadId();
      const leadCode = formatLeadCode(leadId);
      leadCodeValue = leadCode;
      window.leadCodeValue = leadCode;
      const lastSubmit = getRecentSubmit();
      if(lastSubmit.leadCode === leadCode && lastSubmit.ts && Date.now() - lastSubmit.ts < 120000){
        showLeadNotice("Hai già inviato la richiesta.", false);
        if(btnLead){
          btnLead.disabled = false;
          btnLead.textContent = "INVIA RICHIESTA";
        }
        isSubmitting = false;
        return;
      }

      const fileErrors = validateFiles(selectedFiles);
      if(fileErrors.length){
        showLeadNotice(fileErrors.join(" "), false);
        if(btnLead){
          btnLead.disabled = false;
          btnLead.textContent = "INVIA RICHIESTA";
        }
        isSubmitting = false;
        return;
      }

      const attachments = [];
      const failedAttachments = [];
      const statuses = selectedFiles.map(() => "In attesa");
      renderFileList(statuses);

      const payload = {
        leadId,
        leadCode,
        honeypot: honeypotInput?.value?.trim() || "",
        contact,
        run: {
          id: pickedRun.id,
          created_at: pickedRun.created_at,
          updated_at: pickedRun.updated_at,
          current_step: pickedRun.current_step,
          status: pickedRun.status,
          result: pickedRun.result,
          notes: pickedRun.notes,
          answers: pickedRun.answers,
          user_id: pickedRun.user_id
        },
        attachments,
        failedAttachments,
        meta: {
          userAgent: navigator.userAgent,
          pageUrl: location.href,
          ts: new Date().toISOString()
        }
      };

      try{
        if(selectedFiles.length > 0){
          setUploadStatus("Caricamento allegati in corso…");
          for(let i = 0; i < selectedFiles.length; i += 1){
            const file = selectedFiles[i];
            statuses[i] = "Preparazione upload…";
            renderFileList(statuses);
            const metaRes = await fetch("/.netlify/functions/lead-upload-url", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                leadId,
                filename: file.name,
                contentType: file.type || "application/octet-stream"
              })
            });
            const metaData = await metaRes.json().catch(() => ({}));
            if(!metaRes.ok || !metaData.ok){
              statuses[i] = "Errore upload";
              failedAttachments.push(file.name);
              renderFileList(statuses);
              continue;
            }
            statuses[i] = "Caricamento…";
            renderFileList(statuses);
            const uploadRes = await fetch(metaData.signedUploadUrl, {
              method: "PUT",
              headers: { "Content-Type": file.type || "application/octet-stream" },
              body: file
            });
            if(!uploadRes.ok){
              statuses[i] = "Errore upload";
              failedAttachments.push(file.name);
              renderFileList(statuses);
              continue;
            }
            attachments.push({
              name: file.name,
              contentType: file.type || "application/octet-stream",
              gcsPath: metaData.gcsPath,
              signedReadUrl: metaData.signedReadUrl
            });
            statuses[i] = "Caricato";
            renderFileList(statuses);
          }
          setUploadStatus(failedAttachments.length ? "Caricamento completato con errori." : "Allegati caricati con successo.");
        }

        const res = await fetch("/.netlify/functions/lead-submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=> ({}));
        if(!res.ok || !data.ok){
          showLeadNotice("Errore nell’invio. Riprova tra poco.", false);
        }else{
          const submittedAt = new Date().toLocaleString("it-IT");
          window.lastSubmittedAt = submittedAt;
          setRecentSubmit({ leadCode, ts: Date.now() });
          showLeadConfirmation({
            leadCode: data.leadCode || leadCode,
            submittedAt,
            failedAttachments
          });
        }
      }catch(e){
        showLeadNotice("Errore durante l’invio o il caricamento. Riprova tra poco.", false);
      }finally{
        if(btnLead){
          btnLead.disabled = false;
          btnLead.textContent = "INVIA RICHIESTA";
        }
        isSubmitting = false;
      }
    }

    if(btnLead){
      btnLead.addEventListener("click", (ev)=>{
        ev.preventDefault();
        sendLead();
      });
    }

    if(printLead){
      printLead.addEventListener("click", (ev) => {
        ev.preventDefault();
        if(typeof window.refreshPrintArea === "function"){
          window.refreshPrintArea();
        }
        window.print();
      });
    }

    restoreDraft();
    wireDraftInputs();

  </script>
  <div class="print-area" id="printArea">
    <h1>Riepilogo richiesta</h1>
    <p><strong>Codice pratica:</strong> <span id="printLeadCode"></span></p>
    <p><strong>Data/ora invio:</strong> <span id="printLeadDate"></span></p>
    <h2>Contatti</h2>
    <p id="printContact"></p>
    <h2>Esito</h2>
    <p id="printResult"></p>
  </div>
  <script>
    const printLeadCode = document.querySelector("#printLeadCode");
    const printLeadDate = document.querySelector("#printLeadDate");
    const printContact = document.querySelector("#printContact");
    const printResult = document.querySelector("#printResult");
    function refreshPrintArea(){
      const name = document.querySelector("#contactName")?.value?.trim() || "-";
      const email = document.querySelector("#contactEmail")?.value?.trim() || "-";
      const phone = document.querySelector("#contactPhone")?.value?.trim() || "-";
      const city = document.querySelector("#contactCity")?.value?.trim() || "-";
      if(printLeadCode) printLeadCode.textContent = window.leadCodeValue || "—";
      if(printLeadDate) printLeadDate.textContent = window.lastSubmittedAt || new Date().toLocaleString("it-IT");
      if(printContact) printContact.textContent = `${name} • ${email} • ${phone} • ${city}`;
      if(printResult) printResult.textContent = document.querySelector("#badgeTxt")?.textContent || "-";
    }
    window.refreshPrintArea = refreshPrintArea;
  </script>
</body>
</html>
